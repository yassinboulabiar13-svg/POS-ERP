<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion du Stock Local - POS</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Note: Using Tailwind via the CDN is fine for development only. For production,
            install Tailwind as a PostCSS plugin or use the Tailwind CLI per
            https://tailwindcss.com/docs/installation -->
</head>

<body class="bg-gray-100">

    <header class="bg-blue-600 text-white p-4 shadow">
        <h1 class="text-2xl font-bold text-center">Module Stock Local - POS</h1>
    </header>

    <main class="p-6 max-w-5xl mx-auto">

        <section>
            <h2 class="text-xl font-semibold mb-4">Articles Disponibles</h2>
            <div id="articlesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>

        <section class="mt-10">
            <h2 class="text-xl font-semibold mb-4">Panier / Réservations</h2>
            <div id="cartList" class="space-y-2 bg-white p-4 rounded shadow">
                <p id="emptyCart" class="text-gray-500 text-center">Panier vide</p>
            </div>
            <button id="checkoutBtn"
                class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Valider la vente
            </button>
        </section>

        <section class="mt-10">
            <h2 class="text-xl font-semibold mb-4">Administration Stock</h2>
            <div class="flex gap-4">
                <button onclick="cleanupReservations()"
                        class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">
                    Nettoyer les réservations expirées
                </button>
                <button onclick="restock()"
                        class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">
                    Simuler Réassort
                </button>
            </div>
        </section>

    </main>

    <div id="toast"
         class="fixed bottom-4 right-4 bg-black text-white px-4 py-2 rounded shadow hidden"></div>

<script>
const API = "http://127.0.0.1:5002";
const CART_ID = 1;

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 2500);
}

async function safeJson(resp) {
    try { return await resp.json(); } catch { return null; }
}

async function loadArticles() {
    try {
        const res = await fetch(`${API}/articles`);
        if (!res.ok) { showToast("Erreur chargement articles"); return; }
        const data = await safeJson(res) || [];
        const container = document.getElementById("articlesList");
        container.innerHTML = "";
        data.forEach(a => {
            const stock = (a.quantity || 0) - (a.reserved_qty || 0);
            container.innerHTML += `
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-semibold">${escapeHtml(a.name || "—")}</h3>
                    <p class="text-gray-600">Stock : ${stock}</p>
                    <p class="text-gray-600">Prix : ${a.price ?? 0} DT</p>
                    <button onclick="addToCart(${a.id})"
                            class="mt-3 bg-blue-600 text-white px-3 py-1 rounded">
                        Ajouter au panier
                    </button>
                </div>
            `;
        });
    } catch (err) {
        showToast("Impossible de charger les articles (réseau)");
    }
}

async function addToCart(articleId) {
    try {
        const res = await fetch(`${API}/cart/add`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ cart_id: CART_ID, article_id: articleId, qty: 1 })
        });
        const data = await safeJson(res);
        if (res.ok) { showToast("Article réservé !"); await loadCart(); await loadArticles(); }
        else { showToast(data?.error || "Erreur lors de l'ajout"); }
    } catch { showToast("Erreur réseau lors de l'ajout"); }
}

async function loadCart() {
    try {
        const res = await fetch(`${API}/cart/${CART_ID}`);
        if (!res.ok) { showToast("Erreur chargement panier"); return; }
        const data = await safeJson(res);
        const items = (data?.items && Array.isArray(data.items)) ? data.items : [];
        const container = document.getElementById("cartList");
        container.innerHTML = `<p id="emptyCart" class="text-gray-500 text-center">Panier vide</p>`;
        if (!items.length) { document.getElementById("emptyCart").style.display = "block"; return; }
        document.getElementById("emptyCart").style.display = "none";
        items.forEach(item => {
            const name = escapeHtml(item.name || ("Article " + (item.article_id || "")));
            const price = item.price ?? 0;
            const reservation_id = item.reservation_id;
            const el = document.createElement("div");
            el.className = "flex justify-between bg-gray-100 p-2 rounded";
            el.innerHTML = `<span>${name} — ${price} DT</span>
                            <button class="text-red-600 hover:text-red-800" data-resid="${reservation_id}">Supprimer</button>`;
            el.querySelector("button").addEventListener("click", () => removeFromCart(reservation_id));
            container.appendChild(el);
        });
    } catch { showToast("Erreur réseau chargement panier"); }
}

async function removeFromCart(resId) {
    try {
        const res = await fetch(`${API}/cart/remove/${resId}`, { method: "DELETE" });
        if (res.ok) { showToast("Réservation supprimée"); await loadCart(); await loadArticles(); }
        else { const data = await safeJson(res); showToast(data?.error || "Erreur suppression"); }
    } catch { showToast("Erreur réseau suppression (vérifie le backend/CORS)"); }
}

async function checkout() {
    try {
        const res = await fetch(`${API}/checkout/${CART_ID}`, { method: "POST" });
        const data = await safeJson(res);
        showToast(res.ok ? "Vente confirmée !" : data?.error || "Erreur checkout");
        await loadCart(); await loadArticles();
    } catch { showToast("Erreur réseau checkout"); }
}

async function cleanupReservations() {
    try {
        const res = await fetch(`${API}/admin/cleanup_reservations`, { method: "POST" });
        showToast(res.ok ? "Réservations expirées nettoyées" : "Erreur cleanup");
        await loadCart(); await loadArticles();
    } catch { showToast("Erreur réseau cleanup"); }
}

async function restock() {
    try {
        const res = await fetch(`${API}/admin/restock`, { method: "POST" });
        showToast(res.ok ? "Réassort effectué" : "Erreur restock");
        await loadArticles();
    } catch { showToast("Erreur réseau restock"); }
}

function escapeHtml(unsafe) {
    return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
}

document.getElementById("checkoutBtn").onclick = checkout;
loadArticles();
loadCart();

</script>

</body>
</html>
